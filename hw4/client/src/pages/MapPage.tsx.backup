import { useState, useEffect, useRef, useCallback } from 'react';
import { useNavigate } from 'react-router-dom';
import { importLibrary } from '@googlemaps/js-api-loader';
import axios from 'axios';
import { useAuth } from '../contexts/AuthContext';
import { calculateDistance } from '../utils/haversine';
import Header from '../components/Header';

const motivationalQuotes = [
  'ğŸ’ª æ¯æ®µè·¯ç·šéƒ½æ˜¯ç¨ç‰¹çš„å†’éšª',
  'ğŸŒŸ ä¸€æ­¥ä¸€è…³å°ï¼Œæˆå°±éå‡¡æ—…ç¨‹',
  'ğŸƒ å¥”è·‘å§ï¼è¿½é€å¿ƒä¸­çš„å¤¢æƒ³',
  'â­ å …æŒä¸‹å»ï¼Œä½ æ¯”æƒ³åƒä¸­æ›´å¼·',
  'ğŸ¯ ä»Šå¤©çš„æ±—æ°´ï¼Œæ˜å¤©çš„é©•å‚²',
  'ğŸ”¥ æŒ‘æˆ°è‡ªå·±ï¼Œçªç ´æ¥µé™',
];

export default function MapPage() {
  const mapRef = useRef<HTMLDivElement>(null);
  const [map, setMap] = useState<google.maps.Map | null>(null);
  const [polyline, setPolyline] = useState<google.maps.Polyline | null>(null);
  const [markers, setMarkers] = useState<google.maps.Marker[]>([]);
  const [points, setPoints] = useState<google.maps.LatLng[]>([]);
  const [title, setTitle] = useState('');
  const [description, setDescription] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [tipsExpanded, setTipsExpanded] = useState(true);
  const [currentQuoteIndex, setCurrentQuoteIndex] = useState(0);
  const { logout } = useAuth();
  const navigate = useNavigate();

  // Rotate motivational quotes every 5 seconds
  useEffect(() => {
    const interval = setInterval(() => {
      setCurrentQuoteIndex((prev) => (prev + 1) % motivationalQuotes.length);
    }, 5000);
    return () => clearInterval(interval);
  }, []);

  const addPoint = useCallback((latLng: google.maps.LatLng) => {
    if (!map) return;
    
    setPoints(prevPoints => {
      const newPoints = [...prevPoints, latLng];
      const pointIndex = newPoints.length;
      
      // å‰µå»ºæ¨™è¨˜
      const marker = new google.maps.Marker({
        position: latLng,
        map: map,
        label: {
          text: pointIndex.toString(),
          color: 'white',
          fontWeight: 'bold',
          fontSize: '12px'
        },
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 8,
          fillColor: pointIndex === 1 ? '#10b981' : (pointIndex === newPoints.length ? '#ef4444' : '#3b82f6'),
          fillOpacity: 1,
          strokeColor: 'white',
          strokeWeight: 2
        }
      });
      
      setMarkers(prevMarkers => [...prevMarkers, marker]);

      // æ›´æ–° polyline
      setPolyline(prevPolyline => {
        if (prevPolyline) {
          prevPolyline.setPath(newPoints);
          return prevPolyline;
        } else {
          const newPolyline = new google.maps.Polyline({
            path: newPoints,
            strokeColor: '#3b82f6',
            strokeWeight: 4,
            map
          });
          return newPolyline;
        }
      });
      
      return newPoints;
    });
  }, [map]);

  // åˆå§‹åŒ–åœ°åœ–
  useEffect(() => {
    const initMap = async () => {
      try {
        const { Map } = await importLibrary('maps');

        if (mapRef.current) {
          const mapInstance = new Map(mapRef.current, {
            center: { lat: 25.0330, lng: 121.5654 },
            zoom: 13
          });

          setMap(mapInstance);
        } else {
          console.error('Map container ref is null');
        }
      } catch (error) {
        console.error('Error initializing map:', error);
      }
    };

    initMap();
  }, []);

  // ç•¶åœ°åœ–åˆå§‹åŒ–å¾Œæ·»åŠ é»æ“Šäº‹ä»¶
  useEffect(() => {
    if (!map) return;

    const clickListener = map.addListener('click', (e: google.maps.MapMouseEvent) => {
      if (e.latLng) {
        addPoint(e.latLng);
      }
    });

    return () => {
      google.maps.event.removeListener(clickListener);
    };
  }, [map, addPoint]);

  const clearPoints = () => {
    // æ¸…é™¤æ‰€æœ‰æ¨™è¨˜
    markers.forEach(marker => marker.setMap(null));
    setMarkers([]);
    setPoints([]);
    if (polyline) {
      polyline.setMap(null);
      setPolyline(null);
    }
  };

  const undoLastPoint = () => {
    if (points.length === 0) return;
    
    // ç§»é™¤æœ€å¾Œä¸€å€‹æ¨™è¨˜
    const lastMarker = markers[markers.length - 1];
    if (lastMarker) {
      lastMarker.setMap(null);
      setMarkers(markers.slice(0, -1));
    }
    
    const newPoints = points.slice(0, -1);
    setPoints(newPoints);
    
    // æ›´æ–° polyline
    if (polyline) {
      if (newPoints.length > 0) {
        polyline.setPath(newPoints);
      } else {
        polyline.setMap(null);
        setPolyline(null);
      }
    }
  };

  const handleSubmit = async () => {
    if (points.length < 2) {
      alert('è‡³å°‘éœ€è¦ 2 å€‹é»');
      return;
    }
    if (!title.trim()) {
      alert('è«‹è¼¸å…¥è·¯ç·šåç¨±');
      return;
    }

    setIsSubmitting(true);
    const coordinates = points.map(p => [p.lng(), p.lat()]);
    const distance = calculateDistance(points);

    try {
      await axios.post(`${import.meta.env.VITE_API_BASE_URL}/api/routes`, {
        title: title.trim(),
        description: description.trim() || undefined,
        distanceMeters: distance,
        geojson: {
          type: 'LineString',
          coordinates
        }
      });
      alert('è·¯ç·šå»ºç«‹æˆåŠŸï¼');
      navigate('/routes');
    } catch (error) {
      console.error('å»ºç«‹è·¯ç·šå¤±æ•—:', error);
      alert('å»ºç«‹è·¯ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      setIsSubmitting(false);
    }
  };

  const distance = calculateDistance(points);

  return (
    <div className="h-screen flex flex-col overflow-hidden">
      <Header />
      <div className="flex-1 flex overflow-hidden">
        <div className="flex-1 relative">
          {/* Empty State Overlay */}
          {points.length === 0 && (
            <div className="absolute inset-0 z-10 pointer-events-none flex items-center justify-center">
              <div className="bg-white/95 backdrop-blur-sm rounded-3xl shadow-2xl p-8 max-w-md mx-4 border-4 border-blue-500 animate-pulse">
                <div className="text-center">
                  <div className="text-7xl mb-4 animate-bounce">ğŸ‘†</div>
                  <h3 className="text-2xl font-bold text-gray-800 mb-2">é–‹å§‹è¦åŠƒè·¯ç·šï¼</h3>
                  <p className="text-gray-600 mb-4">åœ¨åœ°åœ–ä¸Šé»æ“Šä»»æ„ä½ç½®æ–°å¢ç¬¬ä¸€å€‹ç¯€é»</p>
                  <div className="flex items-center justify-center gap-2 text-sm text-blue-600 font-semibold">
                    <div className="w-3 h-3 bg-blue-500 rounded-full animate-ping"></div>
                    <span>é»æ“Šåœ°åœ–é–‹å§‹</span>
                  </div>
                </div>
              </div>
            </div>
          )}

          <div
            className="w-full h-full"
            ref={mapRef}
            style={{ minHeight: '100%', minWidth: '300px' }}
          ></div>
        </div>
        <div className="w-80 bg-white border-l border-gray-200 shadow-lg overflow-y-auto flex flex-col">
          {/* Gradient Header with Decorative Elements */}
          <div className="relative bg-gradient-to-br from-blue-500 via-cyan-500 to-teal-400 p-6 text-white overflow-hidden">
            {/* Decorative blob shapes */}
            <div className="absolute top-0 right-0 w-32 h-32 bg-white opacity-10 rounded-full blur-2xl -mr-16 -mt-16"></div>
            <div className="absolute bottom-0 left-0 w-24 h-24 bg-white opacity-10 rounded-full blur-xl -ml-12 -mb-12"></div>

            {/* Dot pattern overlay */}
            <div className="absolute inset-0 bg-dots-pattern opacity-30"></div>

            {/* Content */}
            <div className="relative z-10 text-center">
              <div className="text-6xl mb-3 animate-bounce">ğŸ—ºï¸</div>
              <h2 className="text-2xl font-bold mb-1">å»ºç«‹æ–°è·¯ç·š</h2>
              <p className="text-sm text-blue-100">é»æ“Šåœ°åœ–é–‹å§‹è¦åŠƒæ‚¨çš„è·‘æ­¥è·¯ç·š</p>
            </div>
          </div>

          {/* Wave separator */}
          <div className="h-4 bg-gradient-to-b from-teal-400 to-white"></div>

          <div className="flex-1 p-4">{/* Main content container */}

        {/* Enhanced Stats Card with Progress and Achievements */}
        <div className="mb-4 p-5 bg-gradient-to-br from-orange-50 via-pink-50 to-purple-50 rounded-2xl border-2 border-orange-100 shadow-md">
          <div className="space-y-4">
            {/* Nodes Count */}
            <div>
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm text-gray-700 font-semibold flex items-center gap-1">
                  <span className="text-lg">ğŸ“</span> ç¯€é»æ•¸
                </span>
                <span className="text-3xl font-bold bg-gradient-to-r from-orange-600 to-pink-600 gradient-text">
                  {points.length}
                </span>
              </div>
              {/* Progress bar for nodes */}
              <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                <div
                  className="h-full bg-gradient-to-r from-orange-500 to-pink-500 transition-all duration-500"
                  style={{ width: `${Math.min((points.length / 10) * 100, 100)}%` }}
                ></div>
              </div>
              <p className="text-xs text-gray-500 mt-1">
                {points.length < 2 ? 'è‡³å°‘éœ€è¦ 2 å€‹ç¯€é»' : points.length >= 10 ? 'ç²¾ç´°è·¯ç·šï¼' : `è·é›¢ç²¾ç´°è¨˜éŒ„é‚„å·® ${10 - points.length} å€‹ç¯€é»`}
              </p>
            </div>

            {/* Distance */}
            <div>
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm text-gray-700 font-semibold flex items-center gap-1">
                  <span className="text-lg">ğŸ“</span> è·é›¢
                </span>
                <span className="text-3xl font-bold bg-gradient-to-r from-blue-600 to-cyan-600 gradient-text">
                  {(distance / 1000).toFixed(2)} km
                </span>
              </div>
              {/* Progress bar for distance */}
              <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                <div
                  className="h-full bg-gradient-to-r from-blue-500 to-cyan-500 transition-all duration-500"
                  style={{ width: `${Math.min((distance / 10000) * 100, 100)}%` }}
                ></div>
              </div>
              <p className="text-xs text-gray-500 mt-1">
                {distance >= 10000 ? 'è¶…é•·è·é›¢æŒ‘æˆ°ï¼' : distance >= 5000 ? 'å·²é” 5 å…¬é‡Œï¼' : distance >= 1000 ? 'å·²é” 1 å…¬é‡Œï¼' : 'ç¹¼çºŒåŠ æ²¹'}
              </p>
            </div>

            {/* Achievement Badges */}
            {(points.length >= 2 || distance >= 1000) && (
              <div className="pt-3 border-t border-orange-200">
                <p className="text-xs text-gray-600 font-semibold mb-2">ğŸ† å³æ™‚æˆå°±</p>
                <div className="flex flex-wrap gap-1.5">
                  {points.length >= 2 && (
                    <span className="badge-achievement bg-green-500 text-xs px-2 py-1">
                      âœ“ å¯å»ºç«‹è·¯ç·š
                    </span>
                  )}
                  {points.length >= 5 && (
                    <span className="badge-achievement bg-blue-500 text-xs px-2 py-1">
                      â­ 5å€‹ç¯€é»
                    </span>
                  )}
                  {points.length >= 10 && (
                    <span className="badge-achievement bg-purple-500 text-xs px-2 py-1">
                      ğŸŒŸ ç²¾ç´°è¨˜éŒ„
                    </span>
                  )}
                  {distance >= 1000 && (
                    <span className="badge-achievement bg-cyan-500 text-xs px-2 py-1">
                      ğŸƒ 1å…¬é‡Œ
                    </span>
                  )}
                  {distance >= 5000 && (
                    <span className="badge-achievement bg-orange-500 text-xs px-2 py-1">
                      ğŸ–ï¸ 5å…¬é‡Œ
                    </span>
                  )}
                  {distance >= 10000 && (
                    <span className="badge-achievement bg-pink-500 text-xs px-2 py-1">
                      ğŸ† 10å…¬é‡Œ
                    </span>
                  )}
                </div>
              </div>
            )}

            {/* Estimated Time */}
            {distance > 0 && (
              <div className="pt-3 border-t border-pink-200">
                <div className="flex items-center justify-between">
                  <span className="text-xs text-gray-600 flex items-center gap-1">
                    <span>â±ï¸</span> é ä¼°æ™‚é–“
                  </span>
                  <span className="text-sm font-bold text-gray-700">
                    ç´„ {Math.ceil((distance / 1000) * 6)} åˆ†é˜
                  </span>
                </div>
                <p className="text-xs text-gray-500 mt-0.5">ä»¥ 10 åˆ†/å…¬é‡Œé…é€Ÿè¨ˆç®—</p>
              </div>
            )}
          </div>
        </div>

            {/* Form Inputs */}
        <div className="space-y-3 mb-4">
          <div className="relative">
            <span className="absolute left-3 top-3.5 text-gray-400">âœï¸</span>
            <input
              type="text"
              placeholder="è·¯ç·šåç¨± *"
              className="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all"
              value={title}
              onChange={(e) => setTitle(e.target.value)}
            />
          </div>
          <div className="relative">
            <span className="absolute left-3 top-3 text-gray-400">ğŸ“</span>
            <textarea
              placeholder="æè¿°ï¼ˆé¸å¡«ï¼‰"
              className="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all resize-none"
              rows={3}
              value={description}
              onChange={(e) => setDescription(e.target.value)}
            />
          </div>
        </div>

        {/* Primary Action Button */}
        <button
          onClick={handleSubmit}
          disabled={points.length < 2 || !title || isSubmitting}
          className="w-full bg-gradient-to-r from-orange-500 via-pink-500 to-rose-500 text-white py-4 px-6 rounded-xl font-bold text-lg disabled:from-gray-300 disabled:to-gray-400 disabled:cursor-not-allowed mb-4 flex items-center justify-center gap-2 shadow-xl hover:shadow-2xl hover:scale-[1.02] active:scale-[0.98] transition-all disabled:shadow-none disabled:hover:scale-100"
        >
          {isSubmitting ? (
            <>
              <svg className="animate-spin h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              å„²å­˜ä¸­...
            </>
          ) : (
            <>
              <span className="text-xl">ğŸ’¾</span>
              å„²å­˜è·¯ç·š
            </>
          )}
        </button>

        {/* Secondary Action Buttons */}
        <div className="grid grid-cols-2 gap-3 mb-4">
          <button
            onClick={undoLastPoint}
            disabled={points.length === 0}
            className="flex items-center justify-center gap-2 bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-xl font-semibold disabled:bg-gray-300 disabled:cursor-not-allowed transition-all shadow-md hover:shadow-lg hover:scale-105 active:scale-95 disabled:hover:scale-100"
          >
            <span className="text-lg">â†©ï¸</span>
            <span>æ’¤éŠ·</span>
          </button>
          <button
            onClick={clearPoints}
            disabled={points.length === 0}
            className="flex items-center justify-center gap-2 bg-gradient-to-r from-red-500 to-orange-500 hover:from-red-600 hover:to-orange-600 text-white py-3 px-4 rounded-xl font-semibold disabled:bg-gray-300 disabled:cursor-not-allowed transition-all shadow-md hover:shadow-lg hover:scale-105 active:scale-95 disabled:hover:scale-100"
          >
            <span className="text-lg">ğŸ—‘ï¸</span>
            <span>æ¸…é™¤</span>
          </button>
        </div>

        {/* Tertiary Navigation Button */}
        <button
          onClick={() => navigate('/routes')}
          className="w-full bg-white border-2 border-gray-300 hover:border-blue-500 text-gray-700 hover:text-blue-600 py-3 px-4 rounded-xl font-semibold transition-all shadow-sm hover:shadow-md flex items-center justify-center gap-2"
        >
          <span className="text-lg">ğŸ“‹</span>
          <span>æŸ¥çœ‹è·¯ç·šåˆ—è¡¨</span>
        </button>

        {/* Rotating Motivational Quote */}
        <div className="mt-4 p-4 bg-gradient-to-r from-purple-100 via-pink-100 to-rose-100 rounded-xl border-2 border-purple-200 shadow-sm">
          <div className="flex items-center justify-between">
            <p className="text-sm text-gray-700 font-medium italic transition-all duration-500">
              {motivationalQuotes[currentQuoteIndex]}
            </p>
            <div className="flex gap-1">
              {motivationalQuotes.map((_, index) => (
                <div
                  key={index}
                  className={`h-1.5 w-1.5 rounded-full transition-all duration-300 ${
                    index === currentQuoteIndex ? 'bg-purple-600 w-4' : 'bg-purple-300'
                  }`}
                ></div>
              ))}
            </div>
          </div>
        </div>

        {/* Collapsible Tips Section */}
        <div className="mt-4">
          <button
            onClick={() => setTipsExpanded(!tipsExpanded)}
            className="w-full flex items-center justify-between p-3 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-t-xl border border-blue-200 hover:from-blue-100 hover:to-cyan-100 transition-all"
          >
            <span className="text-sm font-bold text-gray-700 flex items-center gap-2">
              <span className="text-lg">ğŸ’¡</span>
              ä½¿ç”¨å°å¹«æ‰‹
            </span>
            <span className={`text-gray-600 transition-transform duration-300 ${tipsExpanded ? 'rotate-180' : ''}`}>
              â–¼
            </span>
          </button>
          {tipsExpanded && (
            <div className="p-4 bg-gradient-to-br from-blue-50 to-cyan-50 rounded-b-xl border-x border-b border-blue-200 animate-slide-in">
              <ul className="text-sm text-gray-700 space-y-2">
                <li className="flex items-start gap-2">
                  <span className="text-blue-500 font-bold">ğŸ“</span>
                  <span>åœ¨åœ°åœ–ä¸Šé»æ“Šå°±èƒ½æ–°å¢ç¯€é»</span>
                </li>
                <li className="flex items-start gap-2">
                  <span className="text-green-500 font-bold">âœ…</span>
                  <span>è‡³å°‘éœ€è¦ 2 å€‹ç¯€é»æ‰èƒ½å»ºç«‹è·¯ç·š</span>
                </li>
                <li className="flex items-start gap-2">
                  <span className="text-blue-500 font-bold">â†©ï¸</span>
                  <span>é»éŒ¯äº†ï¼Ÿä½¿ç”¨ã€Œæ’¤éŠ·ã€å›åˆ°ä¸Šä¸€æ­¥</span>
                </li>
                <li className="flex items-start gap-2">
                  <span className="text-red-500 font-bold">ğŸ—‘ï¸</span>
                  <span>æƒ³é‡ä¾†ï¼Ÿä½¿ç”¨ã€Œæ¸…é™¤ã€ç§»é™¤æ‰€æœ‰ç¯€é»</span>
                </li>
                <li className="flex items-start gap-2">
                  <span className="text-purple-500 font-bold">ğŸ¯</span>
                  <span>ç¯€é»è¶Šå¤šï¼Œè·¯ç·šè¶Šç²¾ç¢ºï¼</span>
                </li>
              </ul>
            </div>
          )}
        </div>

        </div>{/* End of main content container */}
      </div>{/* End of sidebar */}
    </div>{/* End of flex container */}
    </div>{/* End of screen container */}
  );
}
